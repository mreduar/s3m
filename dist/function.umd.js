!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e||self).s3m=t()}(this,function(){function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},e.apply(null,arguments)}function t(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var n=/*#__PURE__*/function(){function n(e,t){void 0===t&&(t={}),this.file=e,this.options=t,this.chunkSize=t.chunk_size||n.DEFAULT_CHUNK_SIZE,this.maxConcurrentUploads=t.max_concurrent_uploads||n.DEFAULT_MAX_CONCURRENT_UPLOADS,this.fileName=e.name,this.fileSize=e.size,this.fileType=e.type,this.httpClient=t.httpClient?t.httpClient:axios,this.chunkRetries=t.chunk_retries||n.DEFAULT_MAX_CHUNK_RETRIES}var u=n.prototype;return u.startUpload=function(){try{var t=this;if(!t.fileName)throw new Error("Filename is empty");return Promise.resolve(t.httpClient.post("/s3m/create-multipart-upload",e({filename:t.fileName,content_type:t.fileType},t.options.data),e({baseURL:t.options.baseURL||null,headers:t.options.headers||{}},t.options.options))).then(function(e){return e.data})}catch(e){return Promise.reject(e)}},u.upload=function(){try{var e=this;return Promise.resolve(t(function(){return Promise.resolve(e.startUpload(e.file)).then(function(t){var n=t.key,r=t.uploadId,o=t.uuid;if(r){var i=e.options.progress||function(){};return Promise.resolve(e.uploadChunks(n,r,i)).then(function(t){return!1===e.options.auto_complete?(i(100),{uuid:o,key:n,extension:e.fileName.split(".").pop(),name:e.fileName,upload_id:r,parts:t}):Promise.resolve(e.completeUpload(n,r,t)).then(function(t){return i(100),{uuid:o,key:n,extension:e.fileName.split(".").pop(),name:e.fileName,url:t}})})}console.error("Upload ID not found")})},function(e){console.error(e)}))}catch(e){return Promise.reject(e)}},u.uploadChunks=function(e,t,n){try{var u=this,s=Math.ceil(u.fileSize/u.chunkSize),a=new Array(s).fill(0),l=[],c=0,h=0,f=Array.from({length:u.maxConcurrentUploads}).map(function r(){try{if(h>=s)return Promise.resolve();var o=h*u.chunkSize,i=Math.min(o+u.chunkSize,u.fileSize),f=u.file.slice(o,i);return c++,h++,Promise.resolve(u.uploadChunk(e,t,h,f,s,a,n)).then(function(e){l.push(e),--c<u.maxConcurrentUploads&&r()})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(f)).then(function(){function e(){return l.sort(function(e,t){return e.PartNumber-t.PartNumber})}var t=function(e,t,n){for(var u;;){var s=e();if(i(s)&&(s=s.v),!s)return a;if(s.then){u=0;break}var a=n();if(a&&a.then){if(!i(a)){u=1;break}a=a.s}if(t){var l=t();if(l&&l.then&&!i(l)){u=2;break}}}var c=new o,h=r.bind(null,c,2);return(0===u?s.then(p):1===u?a.then(f):l.then(d)).then(void 0,h),c;function f(o){a=o;do{if(t&&(l=t())&&l.then&&!i(l))return void l.then(d).then(void 0,h);if(!(s=e())||i(s)&&!s.v)return void r(c,1,a);if(s.then)return void s.then(p).then(void 0,h);i(a=n())&&(a=a.v)}while(!a||!a.then);a.then(f).then(void 0,h)}function p(e){e?(a=n())&&a.then?a.then(f).then(void 0,h):f(a):r(c,1,a)}function d(){(s=e())?s.then?s.then(p).then(void 0,h):p(s):r(c,1,a)}}(function(){return c>0},void 0,function(){return Promise.resolve(new Promise(function(e){return setTimeout(e,100)})).then(function(){})});return t&&t.then?t.then(e):e()})}catch(e){return Promise.reject(e)}},u.completeUpload=function(t,n,r){try{var o=this;return Promise.resolve(o.httpClient.post("/s3m/complete-multipart-upload",{parts:r,upload_id:n,key:t},e({baseURL:o.options.baseURL||null,headers:o.options.headers||{}},o.options.options))).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},u.getSignUrl=function(t,n,r){try{var o=this;return Promise.resolve(o.httpClient.post("/s3m/create-sign-part",e({filename:o.fileName,content_type:o.fileType,part_number:r,upload_id:n,key:t},o.options.data),e({baseURL:o.options.baseURL||null,headers:o.options.headers||{}},o.options.options))).then(function(e){return e.data.url})}catch(e){return Promise.reject(e)}},u.uploadChunk=function(e,n,r,o,i,u,s){try{var a=this;return Promise.resolve(a.getSignUrl(e,n,r)).then(function(e){return function n(l){void 0===l&&(l=0);try{return Promise.resolve(t(function(){return Promise.resolve(a.httpClient.put(e,o,{headers:{"Content-Type":a.fileType},onUploadProgress:function(e){return a.handleUploadProgress(e,i,r-1,u,s)}})).then(function(e){return{ETag:e.headers.etag,PartNumber:r}})},function(e){if(l<a.chunkRetries)return console.warn("Retrying chunk "+r+", attempt "+(l+1)),n(l+1);throw e}))}catch(e){return Promise.reject(e)}}()})}catch(e){return Promise.reject(e)}},u.handleUploadProgress=function(e,t,n,r,o){var i=Math.round(100*e.loaded/e.total);r[n]=i,o(Math.round(r.reduce(function(e,t){return e+t})/t))},n}();function r(e,t,n){if(!e.s){if(n instanceof o){if(!n.s)return void(n.o=r.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(r.bind(null,e,t),r.bind(null,e,2));e.s=t,e.v=n;const i=e.o;i&&i(e)}}var o=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var o=new e,i=this.s;if(i){var u=1&i?t:n;if(u){try{r(o,1,u(this.v))}catch(e){r(o,2,e)}return o}return this}return this.o=function(e){try{var i=e.v;1&e.s?r(o,1,t?t(i):i):n?r(o,1,n(i)):r(o,2,i)}catch(e){r(o,2,e)}},o},e}();function i(e){return e instanceof o&&1&e.s}return n.DEFAULT_CHUNK_SIZE=10485760,n.DEFAULT_MAX_CONCURRENT_UPLOADS=5,n.DEFAULT_MAX_CHUNK_RETRIES=3,function(e,t){return new n(e,t).upload()}});
